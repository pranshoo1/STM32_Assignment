#include "stm32f0xx_hal.h"
#include <string.h>

TIM_HandleTypeDef tmr2;
ADC_HandleTypeDef adc1;
DMA_HandleTypeDef dma1;
UART_HandleTypeDef uart1;

#define BUF_LEN 100
uint16_t buf[BUF_LEN];
char uart_msg[10];

// ------------------- Prototypes -------------------
void SYSCLK(void);
static void GPIOX(void);
static void TIMX(void);
static void ADCX(void);
static void DMAX(void);
static void UARTX(void);

// ------------------- MAIN -------------------
int main(void)
{
    HAL_Init();
    SYSCLK();
    GPIOX();
    DMAX();
    ADCX();
    UARTX();
    TIMX();

    HAL_ADC_Start_DMA(&adc1,(uint32_t*)buf,BUF_LEN);
    HAL_TIM_Base_Start(&tmr2);

    while(1)
    {
        // CPU free, DMA fills buf automatically
    }
}

// ------------------- TIM2 Init -------------------
static void TIMX(void)
{
    TIM_MasterConfigTypeDef m={0};
    tmr2.Instance=TIM2;
    tmr2.Init.Prescaler=7999;
    tmr2.Init.CounterMode=TIM_COUNTERMODE_UP;
    tmr2.Init.Period=9;
    tmr2.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;
    tmr2.Init.AutoReloadPreload=TIM_AUTORELOAD_PRELOAD_DISABLE;
    HAL_TIM_Base_Init(&tmr2);

    m.MasterOutputTrigger=TIM_TRGO_UPDATE;
    m.MasterSlaveMode=TIM_MASTERSLAVEMODE_DISABLE;
    HAL_TIMEx_MasterConfigSynchronization(&tmr2,&m);
}

// ------------------- ADC1 Init -------------------
static void ADCX(void)
{
    ADC_ChannelConfTypeDef c={0};
    adc1.Instance=ADC1;
    adc1.Init.Resolution=ADC_RESOLUTION_12B;
    adc1.Init.DataAlign=ADC_DATAALIGN_RIGHT;
    adc1.Init.ScanConvMode=ADC_SCAN_DISABLE;
    adc1.Init.ContinuousConvMode=DISABLE;
    adc1.Init.DiscontinuousConvMode=DISABLE;
    adc1.Init.ExternalTrigConv=ADC_EXTERNALTRIGCONV_T2_TRGO;
    adc1.Init.ExternalTrigConvEdge=ADC_EXTERNALTRIGCONVEDGE_RISING;
    HAL_ADC_Init(&adc1);

    c.Channel=ADC_CHANNEL_0;
    c.Rank=ADC_RANK_CHANNEL_NUMBER;
    c.SamplingTime=ADC_SAMPLETIME_41CYCLES_5;
    HAL_ADC_ConfigChannel(&adc1,&c);
}

// ------------------- DMA Init -------------------
static void DMAX(void)
{
    __HAL_RCC_DMA1_CLK_ENABLE();

    dma1.Instance=DMA1_Channel1;
    dma1.Init.Direction=DMA_PERIPH_TO_MEMORY;
    dma1.Init.PeriphInc=DMA_PINC_DISABLE;
    dma1.Init.MemInc=DMA_MINC_ENABLE;
    dma1.Init.PeriphDataAlignment=DMA_PDATAALIGN_HALFWORD;
    dma1.Init.MemDataAlignment=DMA_MDATAALIGN_HALFWORD;
    dma1.Init.Mode=DMA_CIRCULAR;
    dma1.Init.Priority=DMA_PRIORITY_MEDIUM;
    HAL_DMA_Init(&dma1);

    __HAL_LINKDMA(&adc1,DMA_Handle,dma1);

    HAL_NVIC_SetPriority(DMA1_Channel1_IRQn,0,0);
    HAL_NVIC_EnableIRQ(DMA1_Channel1_IRQn);
}

// ------------------- GPIO Init (PA5 LED) -------------------
static void GPIOX(void)
{
    __HAL_RCC_GPIOA_CLK_ENABLE();
    GPIO_InitTypeDef g={0};
    g.Pin=GPIO_PIN_5;
    g.Mode=GPIO_MODE_OUTPUT_PP;
    g.Pull=GPIO_NOPULL;
    g.Speed=GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init(GPIOA,&g);
}

// ------------------- UART Init (PA9=TX, PA10=RX) -------------------
static void UARTX(void)
{
    __HAL_RCC_USART1_CLK_ENABLE();
    uart1.Instance=USART1;
    uart1.Init.BaudRate=115200;
    uart1.Init.WordLength=UART_WORDLENGTH_8B;
    uart1.Init.StopBits=UART_STOPBITS_1;
    uart1.Init.Parity=UART_PARITY_NONE;
    uart1.Init.Mode=UART_MODE_TX_RX;
    uart1.Init.HwFlowCtl=UART_HWCONTROL_NONE;
    uart1.Init.OverSampling=UART_OVERSAMPLING_16;
    HAL_UART_Init(&uart1);
}

// ------------------- DMA IRQ -------------------
void DMA1_Channel1_IRQHandler(void)
{
    HAL_DMA_IRQHandler(&dma1);
}

// ------------------- ADC Callbacks -------------------
void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* h)
{
    if(h->Instance==ADC1)
    {
        HAL_GPIO_TogglePin(GPIOA,GPIO_PIN_5); // LED toggle

        // Send full buffer via UART
        for(int i=0;i<BUF_LEN;i++)
        {
            int len=sprintf(uart_msg,"%u\r\n",buf[i]);
            HAL_UART_Transmit(&uart1,(uint8_t*)uart_msg,len,HAL_MAX_DELAY);
        }
    }
}

void HAL_ADC_ConvHalfCpltCallback(ADC_HandleTypeDef* h)
{
    // optional: first half processing
}

// ------------------- System Clock -------------------
void SYSCLK(void)
{
    RCC_OscInitTypeDef o={0};
    RCC_ClkInitTypeDef c={0};
    o.OscillatorType=RCC_OSCILLATORTYPE_HSI;
    o.HSIState=RCC_HSI_ON;
    o.HSICalibrationValue=RCC_HSICALIBRATION_DEFAULT;
    o.PLL.PLLState=RCC_PLL_NONE;
    HAL_RCC_OscConfig(&o);
    c.ClockType=RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK|RCC_CLOCKTYPE_PCLK1;
    c.SYSCLKSource=RCC_SYSCLKSOURCE_HSI;
    c.AHBCLKDivider=RCC_SYSCLK_DIV1;
    c.APB1CLKDivider=RCC_HCLK_DIV1;
    HAL_RCC_ClockConfig(&c,FLASH_LATENCY_0);
}
